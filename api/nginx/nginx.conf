events {}

http {
    include       mime.types;
    default_type  application/octet-stream;

    upstream api_server {
        # docker-compose.yml에서 백엔드 서비스 이름을 'api'로 설정했다고 가정
        server api:80; 
    }

    server {
        listen 80;
        server_name localhost;

        # 1. Frontend (Static Files - Next.js)
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            # Next.js Static Export 라우팅 지원:
            # 1. 파일 그대로 찾기 ($uri)
            # 2. .html 붙여서 찾기 ($uri.html) - 예: /about -> /about.html
            # 3. 폴더로 찾기 ($uri/)
            # 4. 없으면 404 전용 페이지
            # 5. SPA 라우팅(동적 라우팅)이 필요하면 마지막에 /index.html 추가
            try_files $uri $uri.html $uri/ /index.html; 
        }

        # 2. Backend API
        location /api {
            proxy_pass http://api_server;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 쿠키 경로 재설정 (백엔드에서 오는 쿠키가 전체 사이트에서 유효하도록)
            proxy_cookie_path / /;
        }

        # 3. WebSocket (SockJS/STOMP)
        location /ws {
            proxy_pass http://api_server;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header Origin $http_origin; # Origin 헤더 전달 (CORS 체크용)
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cookie_path / /; # 쿠키 전달 보장
        }
        
        # 4. Swagger UI (Optional)
        location /swagger-ui {
            proxy_pass http://api_server;
            proxy_set_header Host $host;
        }
        location /v3/api-docs {
            proxy_pass http://api_server;
            proxy_set_header Host $host;
        }
    }
}
